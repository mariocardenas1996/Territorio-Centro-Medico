<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Predicaciones</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 10px;
      background: #f4f4f4;
    }
    h1 {
      text-align: center;
      font-size: 1.5em;
    }
    h2 {
      margin-top: 20px;
      color: #333;
      font-size: 1.2em;
    }
    .section {
      margin-bottom: 40px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
      margin-bottom: 10px;
    }
    .box {
      aspect-ratio: 1 / 1;
      background: white;
      border: 2px solid #444;
      display: flex;
      justify-content: center;
      align-items: center;
      cursor: pointer;
      font-weight: bold;
      font-size: 0.9em;
      border-radius: 6px;
      user-select: none;
    }
    .box.marked {
      background: red;
      color: white;
      cursor: default;
    }
    .date {
      font-size: 0.7em;
      color: #555;
      text-align: center;
      margin-top: 3px;
    }
    .reset-btn {
      padding: 6px 12px;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 0.9em;
    }
    .reset-btn:hover {
      background: #0056b3;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 1.2em;
      }
      h2 {
        font-size: 1em;
      }
      .box {
        font-size: 0.8em;
      }
      .date {
        font-size: 0.6em;
      }
      .reset-btn {
        width: 100%;
        padding: 10px;
      }
    }
  </style>
</head>
<body>
  <h1>Registro de Predicaciones</h1>

  <div class="section">
    <h2>PredicaciÃ³n de entre semana</h2>
    <div class="grid" id="grid-semana"></div>
    <button class="reset-btn" onclick="resetearSeccion('grid-semana')">ðŸ”„ Reiniciar secciÃ³n</button>
  </div>

  <div class="section">
    <h2>PredicaciÃ³n SÃ¡bado</h2>
    <div class="grid" id="grid-sabado"></div>
    <button class="reset-btn" onclick="resetearSeccion('grid-sabado')">ðŸ”„ Reiniciar secciÃ³n</button>
  </div>

  <div class="section">
    <h2>PredicaciÃ³n Domingo</h2>
    <div class="grid" id="grid-domingo"></div>
    <button class="reset-btn" onclick="resetearSeccion('grid-domingo')">ðŸ”„ Reiniciar secciÃ³n</button>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js" defer></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js" defer></script>

  <script defer>
    window.onload = () => {
      try {
        const firebaseConfig = {
          apiKey: "AIzaSyB4UZLg690pqV6BcTU1Z5hvwwb1N-Bvvts",
          authDomain: "predicacion-centro-medico.firebaseapp.com",
          databaseURL: "https://predicacion-centro-medico-default-rtdb.firebaseio.com",
          projectId: "predicacion-centro-medico",
          storageBucket: "predicacion-centro-medico.appspot.com",
          messagingSenderId: "911919962458",
          appId: "1:911919962458:web:81ac1da17bcc7a32bc7b63",
          measurementId: "G-HDL9592R95"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        function crearCuadros(inicio, fin, contenedorId) {
          const contenedor = document.getElementById(contenedorId);
          for (let i = inicio; i <= fin; i++) {
            const boxWrapper = document.createElement("div");
            boxWrapper.style.textAlign = "center";

            const box = document.createElement("div");
            box.classList.add("box");
            box.textContent = i;

            const date = document.createElement("div");
            date.classList.add("date");

            const boxId = `${contenedorId}-${i}`;
            box.dataset.id = boxId;

            box.addEventListener("click", () => {
              if (!box.classList.contains("marked")) {
                marcarCaja(box, date, contenedorId);
              }
            });

            boxWrapper.appendChild(box);
            boxWrapper.appendChild(date);
            contenedor.appendChild(boxWrapper);
          }
        }

        function marcarCaja(box, date, contenedorId) {
          box.classList.add("marked");
          const hoy = new Date();
          const fechaStr = hoy.toLocaleDateString("es-ES", {
            day: "2-digit",
            month: "2-digit",
            year: "numeric"
          });
          date.textContent = fechaStr;

          db.ref(`cuadros/${box.dataset.id}`).set({
            marked: true,
            date: fechaStr,
            contenedorId: contenedorId
          });

          const contenedor = document.getElementById(contenedorId);
          const boxes = contenedor.querySelectorAll(".box");
          const todasMarcadas = Array.from(boxes).every(b => b.classList.contains("marked"));

          if (todasMarcadas) {
            setTimeout(() => {
              resetearSeccion(contenedorId, true);
              alert("âœ… Se han completado todas las predicaciones de esta secciÃ³n. Se reinicia el registro.");
            }, 400);
          }
        }

        function resetearSeccion(contenedorId, auto = false) {
          const contenedor = document.getElementById(contenedorId);
          const boxes = contenedor.querySelectorAll(".box");
          const dates = contenedor.querySelectorAll(".date");
          const updates = {};

          boxes.forEach(b => {
            b.classList.remove("marked");
            updates[`cuadros/${b.dataset.id}`] = null;
          });
          dates.forEach(d => d.textContent = "");

          db.ref().update(updates);

          if (!auto) {
            alert("ðŸ”„ Se ha reiniciado manualmente la secciÃ³n.");
          }
        }

        function escucharFirebase() {
          db.ref("cuadros").on("value", snapshot => {
            const data = snapshot.val() || {};

            ["grid-semana", "grid-sabado", "grid-domingo"].forEach(id => {
              const cont = document.getElementById(id);
              if (!cont) return;
              cont.querySelectorAll(".box.marked").forEach(box => {
                box.classList.remove("marked");
                const dateEl = box.nextElementSibling;
                if (dateEl) dateEl.textContent = "";
              });
            });

            Object.entries(data).forEach(([boxId, value]) => {
              if (value.marked) {
                const box = document.querySelector(`.box[data-id="${boxId}"]`);
                const date = box?.nextElementSibling;
                if (box) box.classList.add("marked");
                if (date) date.textContent = value.date;
              }
            });
          });
        }

        crearCuadros(101, 146, "grid-semana");
        crearCuadros(201, 268, "grid-sabado");
        crearCuadros(301, 350, "grid-domingo");

        escucharFirebase();

        console.log("App cargada correctamente y Firebase inicializado");
      } catch (error) {
        console.error("Error inicializando la app:", error);
      }
    };
  </script>
</body>
</html>

